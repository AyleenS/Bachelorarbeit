\chapter{Verfeinerung über Error- und Ruhetraces}

\section{Präkongruenz für Ruhe}

In diesem Kapitel werden wir uns nicht nur um die Erreichbarkeit von
Error-Zuständen kümmern, sondern auch um die Erreichbarkeit von
Ruhe-Zuständen. Wir werden dabei ähnlich vorgehen wie im letzten Kapitel,
jedoch halten wir uns als Quelle an~\cite{Chilton2013}. Darin werden ähnliche
Konzepte beschrieben, jedoch aus Sicht der Traces.\\
Wir sehen die Zustände, die keine Outputs und keine Transitionsmöglichkeit für
eine interne Aktion haben als ruhig an.

\begin{Def}[Ruhe]
  Ein \emph{Ruhe-Zustand} ist ein Zustand in einem \EIO{} der keine
  Outputs zulässt und keine Transitions mit $\tau$ besitzt.\\
  Somit ist die Menge der Ruhe-Zustände in einem \EIO{} wie folgt formal
  definiert: $Qui:=\big\{q\in Q\mid \forall \alpha\in (O\cup \{\tau\}): q
  \overset{\alpha}{\not{\hspace{-0.1cm}\rightarrow}}\big\}$.
\end{Def}

Für die Erreichbarkeit verwenden wir wie im letzten Kapitel wieder den
optimistischen Ansatz der lokalen Erreichbarkeit. Ruhe ist kein
unabwendbaren Fehler, sondern kann durch einen Input reparierbar werden. Somit
ist ein Ruhe-Zustand als nicht so \glqq{}schlimmer\grqq{} Fehler anzusehen wie
ein Error. Somit ist für uns ein Ruhe-Zustand zwar ebenso wie ein Error-Zustand
erreichbar sobald er durch Outputs und $\tau$s erreicht werden kann, jedoch ist
nicht jede beliebige Fortsetzung eines Traces, der diese Eigenschaft erfüllt
ein Ruhe-Trace.

\begin{Def}[error- und ruhefreie Kommunikation]
  Zwei \EIO{}s $S_1$ und $S_2$ \emph{kommunizieren gut}, wenn in ihrer
  Parallelkomposition $S_1\| S_2$ keine Errors und keine Ruhe-Zustände lokal
  erreichbar sind.
\end{Def}

\begin{Def}[Ruhe-Verfeinerungs-Basisrelation]
  Für \EIO{}s $S_1$ und $S_2$ mit der gleichen Signatur schreiben wir
  $S_1\QBRel S_2$, wenn ein Error oder Ruhe-Zustand in $S_1$ nur dann lokal
  erreichbar ist, wenn er auch in $S_2$ lokal erreichbar ist. Diese
  \emph{Basisrelation} stellt eine \emph{Verfeinerung} bezüglich \emph{Errors}
  und \emph{Ruhe-Zustände} dar.\\
  \QCRel{} bezeichnet die \emph{vollständig abstrakte Präkongruenz} von
  \QBRel{} bezüglich $\cdot\|\cdot$.
\end{Def}

Um uns genauer mit den Präkongruenzen auseinandersetzten zu können, brauchen
wir wie im letzten Kapitel die Definition von Traces auf unserer Struktur.
Dadurch erhalten wir die Möglichkeit die gröbste Präkongruenz finden und
definieren zu können.

\begin{Def}[Ruhetraces]
  \label{DefRuhetraces}
  Sei $S$ ein \EIO{} und definiere:
  \begin{itemize}
    \item \emph{strickte Ruhetraces}: $\StQT{}(S) := \{w\in\Sigma ^*\mid q_0
      \overset{w}{\Rightarrow} q\in Qui\}$,
    \item \emph{gekürzte Ruhetraces}: $\PrQT{}(S) := \bigcup\{\prunenew(w)\mid
      w\in \StQT{}(S)\}$.
  \end{itemize}
\end{Def}

\begin{Def}[Ruhe-Semantik]
  \label{DefQTQL}
  Sei $S$ ein \EIO{}.
  \begin{itemize}
    \item Die Menge der \emph{Ruhetraces} von $S$ ist $\QT{}(S) :=
      \PrQT{}(S)\cup \ET{}(S)$.
  \end{itemize}
  Für zwei \EIO{}s $S_1, S_2$ mit der gleichen Signatur schreiben wir
  $S_1\QRel S_2$, wenn $S_1\ERel S_2$ und $\QT{}(S_1)\subseteq \QT{}(S_2)$ gilt.
\end{Def}

Für die Menge der Ruhetraces \QT{} haben wir auch eine Informationsvermischung
mit den Errortraces vorgenommen wie beim fluten der Sprache \EL{}. Da jedoch
durch die Ruhetraces keine neuen Traces entstehen, die nicht bereits in der
gefluteten Sprache \EL{} enthalten wären, müssen wir hier keine neue Flutung
dafür vornehmen. Wir schränken also durch die Relation \QRel{} nur die
bereits existierende Präkongruenz \ERel{} ein.

\begin{satz}[Error- und Ruhe-Semantik für Parallelkompositonen]
  \label{satzQuiSemantik}
  Für zwei komponierbare \EIO{}s $S_1, S_2$ und $S_{12} = S_1\|S_2$ gilt:
  \begin{enumerate}
    \item $\ET{}_{12} = \cont{}(\prune{}((\ET{}_1\|\EL{}_2)\cup (\EL{}_1\|\ET{}_2)))$,
    \item $\QT{}_{12} = \prunenew(\QT{}_1\|\QT{}_2)\cup \ET{}_{12}$,
    \item $\EL{}_{12} = (\EL{}_1\|\EL{}_2)\cup \ET{}_{12}$.
  \end{enumerate}
\end{satz}

\begin{proof}
  ~
  \begin{enumerate}
    \item \hspace{-0.2cm}:
  \end{enumerate}
  \vspace{-0.3cm}
  Der Beweis diese Punktes entspricht dem Beweis von Punkt 1.\ im Beweis von
  Satz~\ref{satzErrorSemanik}.

  2. ``$\subseteq$'':\\
  Hier müssen wir unterscheiden ob wir ein $w\in\PrQT{}_{12}$ betrachten oder
  ein $w\in \ET{}_{12}$. Im zweiten Fall ist das $w$ in der rechten Seite
  enthalten. Somit betrachten wir ab jetzt ein
  $w\in \PrQT{}_{12}$ und versuchen dessen Zugehörigkeit zur rechten Menge zu
  zeigen. Aufgrund von Definition~\ref{DefRuhetraces} wissen wir es gibt ein
  $v\in O_{12}^*$, so dass gilt
  $(q_{01},q_{02}) \overset{wv}{\Rightarrow} (q_1,q_2)$ mit $(q_1,q_2)\in
  Qui_{12}$. Durch Projektion erhalten wir $q_{01} \overset{w_1v_1}{\Rightarrow}
  q_1$ und $q_{02} \overset{w_2v_2}{\Rightarrow} q_2$ mit $w\in w_1\|w_2$ und
  $v\in v_1\|v_2$. Aus
  $(q_1,q_2)\in Qui_{12}$ können wir folgern, dass bereits $q_1\in Qui_1$ und
  $q_2\in Qui_2$ gilt. Somit gilt $w_1v_1\in \StQT{}_1\subseteq \QT{}_1$ und
  $w_2v_2\in \StQT{}_2\subseteq \QT{}_2$. Daraus folgt dann $wv\in
  \QT{}_1\|\QT{}_2$ und somit ist $wv$ in der rechten Seiten der Gleichung
  enthalten.

  2. ``$\supseteq$'':\\
  Wir müssen nun wieder unterscheiden, nach dem aus welcher Menge unser
  betrachtetes Element stammt. Falls $w\in \ET{}_{12}$ gilt, so können wir die
  Zugehörigkeit zur linken Seite direkt folgern. Deshalb betrachten wir für den
  weiteren Beweis dieser
  Inklusionsrichtung ein Element $w\in \QT{}_1\|\QT{}_2$ und zeigen, dass es in
  der linken Menge enthalten ist. Da $\QT{}_i = \StQT{}_i\cup \ET{}_i$ gilt,
  existieren für $w_1$ und $w_2$ mit $w\in w_1\| w_2$ unterschiedliche
  Möglichkeiten:
  \begin{itemize}
    \item Fall 1 ($w_1\in \StQT{}_1\wedge w_2\in \StQT{}_2$): Es gilt in diesem
      Fall $q_{01} \overset{w_1}{\Rightarrow} q_1\in Qui_1$ und $q_{02}
      \overset{w_2}{\Rightarrow} q_2\in Qui_2$. Da $q_1$ und $q_2$ in der
      Ruhe-Menge enthalten sind, ist auch der Zustand, der aus ihnen
      zusammengesetzt ist in der Parallelkomposition ruhig und lässt keine
      Outputs und $\tau$-Transitionen zu. Es gilt also für die Komposition
      $(q_{01},q_{02}) \overset{w}{\Rightarrow} (q_1,q_2)\in Qui_{12}$ und
      dadurch ist $w$ in der linken Seite der Gleichung enthalten, da $w\in
      \StQT{}_{12}\subseteq \QT{}_{12}$ gilt.
    \item Fall 2 ($w_1\in \ET{}_1\vee w_2\in \ET{}_2$): \OBdA{} gilt $w_1\in
      \ET{}_1$. Nun kann $w_2\in \StQT{}_2\subseteq L_2$ gelten oder $w_2\in
      \ET{}_2$ und somit gilt auf jeden Fall $w_2\in \EL{}_2$. Daraus können
      wir dann mit dem ersten Punkt von Satz~\ref{satzErrorSemanik} folgern,
      dass $w\in \ET{}_{12}$ gilt und somit in der linken Seite der Gleichung
      enthalten ist.
  \end{itemize}

  3.:\\
  Der Beweis diese Punktes entspricht dem Beweis von Punkt 2.\ im Beweis von
  Satz~\ref{satzErrorSemanik}.
\end{proof}

Die folgende Proposition ist eine direkte Folgerung aus dem letzten Satz.
Jedoch ist es eine wichtige Feststellung für die weiteren Verlauf die gröbste
Präkongruenz finden zu wollen.

\begin{prop}[Präkongruenz]
  \label{propQuiPrae}
  \QRel{} ist eine Präkongruenz bezüglich $\cdot\|\cdot$.
\end{prop}

\begin{proof}
  Es muss gezeigt werden, wenn $S_1\QRel S_2$ gilt, für jedes $S_3$ auch
  $S_3\|S_1\QRel S_3\|S_2$ gilt. D.h.\ es ist zu zeigen, dass aus $S_1\ERel
  S_2$ und $\QT{}_1\subseteq \QT{}_2$ folgt, $S_{31}\ERel S_{32}$ und
  $\QT{}_{31}\subseteq \QT{}_{32}$. Dies ergibt sich wie im Beweis zu
  Proposition~\ref{propPraekongruenz} aus der Monotonie von \cont{}, \prune{}
  und $\cdot\|\cdot$ auf Sprachen wie folgt:
  \begin{itemize}
    \item $\begin{aligned}[t]
        S_{31} \overset{\mathrm{Beweis}~\ref{propPraekongruenz}}{\ERel} S_{32}
    \end{aligned}$
    \item $\begin{aligned}[t]
        \QT{}_{31} &\overset{\ref{satzQuiSemantik}~2.}{=}
        (\QT{}_3\|\QT{}_1)\cup \ET{}_{31}\\
        &\hspace{-0.5cm}\overset{\ET{}_{31}\subseteq
      \ET{}_{32}}{\overset{\mathrm{und}}{\overset{\QT{}_1\subseteq
      \QT{}_2}{\subseteq}}} (\QT{}_3\|\QT{}_2) \cup \ET{}_{32}\\
        &\overset{\ref{satzQuiSemantik}~2.}{=} \QT{}_{32}
    \end{aligned}$
  \end{itemize}
\end{proof}

\begin{lem}[Verfeinerung mit Ruhe-Zuständen]
  \label{lemQuiVerfeinerung}
  Gegeben sind zwei \EIO{}s $S_1$ und $S_2$ mit der gleichen Signatur. Wenn
  alle Partner \EIO{}s $U$, die mit $S_2$  gut kommunizieren, auch mit $S_1$
  gut kommunizieren, dann verfeinert $S_1$ das \EIO{} $S_2$. Diese Verfeinerung
  entspricht der Relation \QRel{} von oben: Wenn $U\|S_1\QBRel U\|S_2$ für alle
  Partner $U$, dann gilt $S_1\QRel S_2$.
\end{lem}

\begin{proof}
  Da wir davon ausgehen, dass $S_1$ und $S_2$ die gleiche Signatur haben,
  definieren wir $I:=I_1=I_2$ und $O:=O_1=O_2$. Für jeden Partner $U$ gilt
  $I_U=O$ und $O_U=I$.\\
  Um zu zeigen, dass die Relation $S_1\QRel S_2$ gilt, müssen wir die
  folgenden Punkte nachweisen:
  \begin{itemize}
    \item $S_1\ERel S_2$,
    \item $\QT{}(S_1)\subseteq \QT{}(S_2)$.
  \end{itemize}
  Der erste Punkt wurde bereits in Lemma~\ref{lemVerfeinerung}
  gezeigt. So bleibt uns nur noch die Inklusion $\QT{}_1\subseteq \QT{}_2$ zu
  zeigen. Diese Inklusion können wir jedoch noch anlog zum Beweis der Inklusion
  der geflutteten Sprachen in Lemma~\ref{lemVerfeinerung} weiter einschränken.
  Da wir bereits wissen, dass $\ET{}_1\subseteq\ET{}_2$ gilt, müssen wir nur
  noch $\StQT{}_1\subseteq \QT{}_2$ zeigen.\\
  Wir wählen ein $w\in \StQT{}(S_1)$ und zeigen, dass es auch in $\QT{}(S_2)$
  enthalten ist.
  \begin{itemize}
    \item Fall 1 ($w=\varepsilon$): Somit ist der Startzustand von $S_1$ ein
      Ruhe-Zustand. Sobald der Startzustand eines Partners $U$ nicht
      ruhig ist, können wir nichts für $S_2$ schließen. Somit wählen wir
      für $U$ ein Transitionssystem, dass nur aus dem Startzustand und einer
      Schliefe für alle Inputs $x\in I_U$ besteht. Somit ist der Startzustand
      von $U$ auch ruhig. Daraus folgt, dass auch der Startzustand der
      Komposition $U\|S_1$ ein Ruhe-Zustand ist. Dadurch muss auch
      $U\|S_2$ einen Ruhe-Zustand als Startzustand haben. Da dieser aber
      nur entstehen kann, wenn für beide Teilsysteme bereits $\varepsilon$ in
      den jeweiligen strikten Ruhetraces liegt, gilt somit $\varepsilon\in
      \StQT{}(S_2)\subseteq \QT{}(S_2)$.
    \item Fall 2 ($w=x_1\dots x_n\in\Sigma ^+$ mit $n\geq 0$): Wir betrachten
      den Partner $U$, bei dem mit $w$ ebenfalls ein Zustand erreicht wird, der
      ruhig ist. Somit ist in der Komposition die Komposition dieser
      beiden Zustände ebenfalls ein Ruhe-Zustand. Es folgt, dass ein
      Ruhe-Zustand auch in $U\|S_2$ durch $w$ erreichbar sein muss und
      somit auch in $S_2$. Daraus folgt, dass gilt $w\in \StQT{}(S_2)\subseteq
      \QT{}(S_2)$.
  \end{itemize}
\end{proof}

\begin{satz}[Full Abstractness für Ruhe-Semantik]
  \label{satzQuiFullAbst}
  Seien $S_1$ und $S_2$ zwei \EIO{}s mit derselben Signatur. Dann gilt
  $S_1\QCRel S_2\Leftrightarrow S_1\QRel S_2$, insbesondere ist \QRel{} eine
  Präkongruenz.
\end{satz}

\begin{proof}
  Wie bereits in Proposition~\ref{propQuiPrae} festgehalten, ist \QRel{} eine
  Präkongruenz.

  \glqq{}$\Leftarrow$\grqq{}: Nach Definition gilt, wenn
  $\varepsilon\in\QT{}(S)$, ist in $S$ ein Ruhe-Zustand durch ein $\tau$
  erreichbar oder ein Error-Zustand lokal erreichbar. Somit impliziert
  $S_1\QRel S_2$, dass $\varepsilon\in\QT{}_2$ gilt, wenn
  $\varepsilon\in\QT{}_1$. Daraus folgt ebenfalls, dass $S_1\QBRel S_2$ gilt.
  Somit folgt aus $S_1\QRel S_2$ der relationale Zusammenhang $S_1\QCRel S_2$.

  \glqq{}$\Rightarrow$\grqq{}: Durch die Definition von \QCRel{} folgt aus
  $S_1\QCRel{} S_2$, dass $U\|S_1\QCRel U\|S_2$ für alle EIOs $U$ , die mit
  $S_1$ komponierbar sind. Somit folgt auch die Gültigkeit von $U\|S_1\EBRel
  U\|S_2$ für alle diese EIOs $U$. Mit Lemma~\ref{lemQuiVerfeinerung} folgt
  dann $S_1\QRel{} S_2$.
\end{proof}

Wir haben somit, wie im letzten Kapitel, eine Kette an Folgerungen gezeigt, die
sich zu einem Ring schließen. Dies ist in Abbildung~\ref{FolgerungsketteQui}
dargestellt.

\begin{figure}[h!tbp]
  \begin{center}
    \begin{tikzpicture}
      \matrix (m) [matrix of math nodes,row sep=2cm,column sep=4cm]{
        S_1\QRel S_2 & S_1\QCRel S_2 \\
        \substack{\forall~\mathrm{Partner}~U:\\U\|S_1\QBRel U\|S_2} &
      \substack{\forall~\mathrm{komponierbaren}~U:\\U\|S_1\QBRel U\|S_2} \\};
        \draw[-implies, double, double distance=1mm]
          (m-1-1) -- node [above] {\glqq{}$\Leftarrow$\grqq{} von
            Satz~\ref{satzQuiFullAbst}} (m-1-2);
        \draw[-implies, double, double distance=1mm]
          (m-1-2) -- node [right] {\glqq{}$\Rightarrow$\grqq{} von
            Satz~\ref{satzQuiFullAbst}} (m-2-2);
        \draw[-implies, double, double distance=1mm]
          (m-2-1) -- node [left]
          {Lemma~\ref{lemQuiVerfeinerung}} (m-1-1);
        \draw[-implies, double, double distance=1mm]
        (m-2-2) -- node [below]
        {$\substack{U~\mathrm{Partner}\\\Downarrow\\U~\mathrm{komponierbar}}$} (m-2-1);
    \end{tikzpicture}
    \caption{Folgerungskette}
    \label{FolgerungsketteQui}
  \end{center}
\end{figure}

Aus Satz~\ref{satzQuiFullAbst} und Lemma~\ref{lemQuiVerfeinerung} erhalten wir
das folgende Korollar.

\begin{kor}
  Ein \EIO{} $S_1$ verfeinert einen \EIO{} $S_2$ genau dann, wenn für alle
  \EIO{}s $U$ für die $S_2$ gut mit $U$ kommuniziert folgt $S_1$ kommuniziert
  ebenfalls gut mit $U$.\\
  Dies lässt sich formal wie folgt ausdrücken: $S_1\QRel S_2\Leftrightarrow
  U\|S_1\QBRel U\|S_2$ für alle Partner $U$.
\end{kor}

\section{Hiding für Ruhe}

Wir wollen nun auch hier die Auswirkungen der Internalisierung von Aktionen auf
unsere Verfeinerungsrelationen untersuchen. Es werden Outputs in interne
Handlungen umgewandelt. Da wir jedoch bei unseren Ruhe-Zuständen auch $\tau$
Übergänge verboten haben, verändert sich nichts an der Menge der ruhigen
Zustände. Da wir die Erreichbarkeit von Ruhe-Zuständen nur mittels interner
Aktionen betrachten, können durch das verbergen von Outputs neue erreichbare
Ruhe-Zustände hinzu kommen. Somit ist es nicht möglich hier eine analoge
Proposition zu~\ref{propErBaIn} zu formulieren. Wir können zwar daraus
schließen, dass alle Ruhe-Zustände die vor dem Hiding zu erreichen waren mit
$\tau$s auch danach noch erreichbar sind, jedoch können durch die
Internalisierung neue erreicht werden, die möglicherweise in dem anderen
Transitionssystem nicht erreicht werden können.\\
Da wir jedoch für die Präkongruenz \QRel{} noch wissen über die
Teilmengenbeziehungen der Traces haben, können wir einen Satz analog
zu~\ref{satzPraeInternalisierung} formulieren.

\begin{satz}[Präkongurenz bzgl. Internalisierung]
  \label{satzPraeInterQui}
  Seien $S_1$ und $S_2$ zwei \EIO{}s für die $S_1\QRel S_2$ gilt, somit gilt
  auch $(S_1/\{x_1,x_x,\dots ,x_n\})\QRel (S_2/\{x_1,x_x,\dots ,x_n\})$. Somit
  ist also \QRel{} eine Präkongruenz bezüglich $\cdot /\cdot$.
\end{satz}

\begin{proof}
  Da $S_1\QRel S_2$ gilt, wissen wir, dass $S_1\ERel S_2$ und $\QT{}_1\subseteq
  \QT{}_2$ gilt. Wir wissen bereits aufgrund von
  Satz~\ref{satzPraeInternalisierung}, dass daraus $(S_1/\{x_1,x_x,\dots
  ,x_n\})\ERel (S_2/\{x_1,x_x,\dots ,x_n\})$ folgt. Ebenso wie im Beweis zu
  Satz~\ref{satzPraeInternalisierung} gehen wir hier davon aus, dass
  $X\subseteq O$ gilt. Für jeden Trace aus $\QT{}_1$ können wir einen passenden in
  $\QT{}(S_1/X)$ finden und ebenso für das Transitionssystem $S_2$. Die
  Argumentation läuft hierfür analog zum Beweis von
  Satz~\ref{satzPraeInternalisierung}. Das oben erwähnte Problem mit der neuen
  Erreichbarkeit von Ruhe-Zuständen ist damit auch bereits behandelt. Es
  entstehen keine neuen ruhigen Zustände, sondern durch das verbergen eines
  Outputs, der direkt zu einem Ruhe-Zustand führt, wird von dem ursprünglichen
  Zustand der Ruhe-Zustand durch ein $\tau$ erreichbar. Somit wir der
  Ruhetrace nur um den zu verbergenden Output gekürzt, was bereits dem
  entspricht einen passenden Trace dafür in $\QT{}(S_i/X)$ zu finden. Somit gilt
  also auch $\QT{}(S_1/X)\subseteq \QT{}(S_2/X)$. Daraus folgt dann, dass die
  Relation \QRel{} trotz Hiding erhalten ist und somit das Hiding bezüglich
  dieser Relation eine Präkongruenz ist.
\end{proof}

In Definition~\ref{defIntParal} wurde mit Hilfe des Internalisierungsoperator
aus der Parallelkomposition ohne Verbergen die Parallelkomposition mit
Verbergen der synchronisierten Aktionen nachgebildet. Wir können deren
Eigenschaft als Präkongruenz aus den Präkongruenz-Eigenschaften von
$\cdot\|\cdot$ und $\cdot /\cdot$ bezüglich \QRel{} aus der
Proposition~\ref{propQuiPrae} und dem Satz~\ref{satzPraeInterQui} schließen.

\begin{kor}[Präkongruenz mit Internalisierung]
  \QRel{} ist eine Präkongruenz bezüglich $\cdot |\cdot$.
\end{kor}
